#!/usr/bin/env python

import sys
import os
import subprocess
from buildconfig import *

def perform_command(command):
    print(">", command)
    cmd = [command.get_shell()] if command.is_shell() else command.get_cmd()
    cwd = command.get_cwd()
    env = os.environ.copy()
    env.update(command.get_env())
    if command.persistent:
        if command.restart:
            runpersistent.kill(command.get_persistent_id())
        runpersistent.open(
            command.get_persistent_id(),
            [command.shell] if command.is_shell() else cmd,
            shell=command.is_shell(),
            cwd=cwd,
            env=env
        )
    else:
        proc = subprocess.Popen(
            cmd,
            bufsize=0,
            shell=command.is_shell(),
            cwd=cwd,
            env=env
        )
        ret = proc.wait()
        assert ret == 0

config = BuildConfig.load_at_path(sys.argv[1])
targets = config.get_targets_for_file(sys.argv[1]) + config.get_global_targets()
if len(sys.argv) < 3:
    for target in targets:
        print(target.name)
else:
    target = config.get_target_by_name(sys.argv[2])
    config.params['file'] = sys.argv[1]
    for command in target.get_commands():
        perform_command(command)

